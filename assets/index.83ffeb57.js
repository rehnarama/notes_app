var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,r=(t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n,a=(e,t)=>{for(var s in t||(t={}))i.call(t,s)&&r(e,s,t[s]);if(n)for(var s of n(t))o.call(t,s)&&r(e,s,t[s]);return e},h=(e,n)=>t(e,s(n));import{c as l,s as c,p as u,a as p,f as d,b as g,m,d as f,e as v,r as x,g as y,h as w,R as P,i as _}from"./vendor.4e3e5a43.js";function E(e){return{start:new C((e[0].x+e[1].x)/2,(e[0].y+e[1].y)/2,(e[0].pressure+e[1].pressure)/2),end:new C((e[1].x+e[2].x)/2,(e[1].y+e[2].y)/2,(e[1].pressure+e[2].pressure)/2),control:e[1]}}function b(e,t,s,n){const i=1-e,o=i*i*t.x+2*e*i*s.x+e*e*n.x,r=i*i*t.y+2*e*i*s.y+e*e*n.y,a=i*i*t.pressure+2*e*i*s.pressure+e*e*n.pressure;return new C(o,r,a)}function A(e){const t=[],s=e.length,n=[e[0],...e,e[s-1]],i=new Array(3);for(const o of n){if(i[0]=i[1],i[1]=i[2],i[2]=o,!i[0])continue;const{start:e,control:s,end:n}=E(i),r=e.x-s.x+(s.x-n.x),a=e.y-s.y+(s.y-n.y),h=.5*Math.sqrt(r*r+a*a);for(let i=0;i<=1;i+=1/h){let o=b(i,e,s,n);t.push(o)}}return t}function I(e,t,s,n=!0){n&&(s=function(e,t,s){return Math.min(Math.max(e,t),s)}(s,0,1));return e*(1-s)+t*s}function M(e,t,s,n=!0){return I(e,t,(i=s,Math.sqrt(i)),n);var i}class C{constructor(e,t,s){this.x=e,this.y=t,this.pressure=s||.5}static lerp(e,t,s){return new C(I(e.x,t.x,s),I(e.y,t.y,s),I(e.pressure,t.pressure,s))}}class L{constructor(e,t=!1,s=!0){this.lineVertices=new Map,this.lines=new Map,this.dirtyLines=new Map,this.vertices=[],this.pen=e,this.interpolate=t,this.dejitter=s}addLine(e,t){const s={points:this.interpolate?A(t.points):t.points,color:t.color,thickness:t.thickness};this.lines.set(e,s),this.dirtyLines.set(e,!0)}removeLine(e){this.lines.delete(e),this.dirtyLines.delete(e),this.lineVertices.delete(e)}generateData(){let e=0;for(const[t,s]of this.lines){if(this.dirtyLines.get(t)){const e=this.pen.generateAttributeData(s,this.dejitter);this.lineVertices.set(t,e),this.dirtyLines.set(t,!1)}const n=this.lineVertices.get(t);for(const t of n.vertices)this.vertices[e]=t,e++}return this.vertices.length>e&&this.vertices.splice(e,this.vertices.length-e),{vertices:this.vertices}}}class D{constructor(e){this.glApp=e}createProgramInfo(e,t){return l(this.glApp.gl,[e,t])}useProgram(e){this.glApp.gl.useProgram(e.program)}}class O extends D{constructor(e,t){super(e),this.vao=null,this.vbo=null,this.isDirty=!1,this.programInfo=null,this.attributeLocations={position:0,color:0},this.lineGenerator=null,this.initProgram=e=>(this.programInfo=this.createProgramInfo("#version 300 es\nprecision highp float;\n\nin vec4 a_position;\nin vec4 a_color;\n\nout vec4 v_color;\n\nuniform mat3 u_vp;\n\nvoid main() {\n  gl_Position = vec4(u_vp * vec3(a_position.xy, 1), a_position.w);\n  v_color = a_color;\n}\n  ","#version 300 es\nprecision highp float;\n\nin vec4 v_color;\nout vec4 output_color;\n\nvoid main(void) {\n  output_color = v_color;\n}"),this.useProgram(this.programInfo),this.attributeLocations.position=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_position"),this.attributeLocations.color=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_color"),this.setupBuffers(e),this.programInfo),this.loadData=e=>{this.isDirty=!0,this.lineGenerator=e,this.glApp.requestFrame()},this.draw=e=>{if(null===this.lineGenerator)return;const t=this.lineGenerator.generateData();if(null===this.programInfo||null===t)return;this.useProgram(this.program),e.gl.bindVertexArray(this.vao),this.isDirty&&(e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.bufferData(this.glApp.gl.ARRAY_BUFFER,new Float32Array(t.vertices),this.glApp.gl.STREAM_DRAW),this.isDirty=!1);const s=t.vertices.length/6;c(this.programInfo,{u_vp:this.canvas.vp_matrix}),e.gl.drawArrays(e.gl.TRIANGLES,0,s)},this.canvas=t,this.program=this.initProgram(e)}setupBuffers(e){this.programInfo&&(this.vao=this.glApp.gl.createVertexArray(),e.gl.bindVertexArray(this.vao),this.vbo=this.glApp.gl.createBuffer(),e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.enableVertexAttribArray(this.attributeLocations.position),e.gl.enableVertexAttribArray(this.attributeLocations.color),e.gl.vertexAttribPointer(this.attributeLocations.position,2,this.glApp.gl.FLOAT,!1,24,0),e.gl.vertexAttribPointer(this.attributeLocations.color,4,this.glApp.gl.FLOAT,!1,24,8))}}function R(e){const t=e.pressure;return 1+5*(t*t)}function S(e,t,s,n,i){e.push(t.x,t.y,...i,s.x,s.y,...i,n.x,n.y,...i)}function N(e,t,s,n,i,o){S(e,t,n,s,o),S(e,s,n,i,o)}function k(e,t,s=1){const n=[],i=R(e)*s,o=2*(i*Math.PI),r=Math.min(2*Math.PI/o,.5);for(let a=0;a<=2*Math.PI;a+=r){const s=i*Math.cos(a)+e.x,o=i*Math.sin(a)+e.y,h=Math.min(2*Math.PI,a+r);S(n,e,{x:s,y:o},{x:i*Math.cos(h)+e.x,y:i*Math.sin(h)+e.y},t)}return n}class T{constructor(e,t,s,n){this.p0=e,this.p1=t,this.p2=s,this.p3=n}evaluate(e){const t=C.lerp(this.p0,this.p1,e),s=C.lerp(this.p1,this.p2,e),n=C.lerp(this.p2,this.p3,e),i=C.lerp(t,s,e),o=C.lerp(s,n,e);return C.lerp(i,o,e)}}const B={generateAttributeData(e,t=!0){const s=e.points;if(0===s.length)return{vertices:[]};let n=null,i=k(s[0],e.color,e.thickness);const o=new Array(4);o[0]=s[0],o[1]=s[0],o[2]=s[0],o[3]=s[0];for(let r=0;r<s.length;r++){let a=s[r],h=s[r+1];if(t){o[(r+1)%o.length]=s[Math.min(r+1,s.length-1)],o[(r+2)%o.length]=s[Math.min(r+2,s.length-1)];const e=o[(r+4+0)%o.length],t=o[(r+4+1)%o.length],n=o[(r+4+2)%o.length],i=o[(r+4+3)%o.length],l=new T(e,t,n,i);a=l.evaluate(r<=2?0:.33),h=l.evaluate(r===s.length-1?1:.66)}if(null===n){n=a;continue}const l=a.x-n.x,c=a.y-n.y;let u=l,p=c;h&&(u=h.x-a.x,p=h.y-a.y);const d=Math.atan2(c,l),g=Math.atan2(p,u);let m=d+Math.PI/2,f=Math.cos(m),v=Math.sin(m);const x=R(a)*e.thickness,y=R(n)*e.thickness;let w={x:n.x+f*y,y:n.y+v*y},P={x:n.x-f*y,y:n.y-v*y},_={x:a.x+f*x,y:a.y+v*x},E={x:a.x-f*x,y:a.y-v*x};N(i,n,w,a,_,e.color),N(i,n,P,a,E,e.color);const b=Math.min(d,g),A=Math.max(d,g),I=Math.sign(d-g);let M=null,C=b;for(;C<=A;){const t=C+Math.PI/2,s={x:a.x+I*Math.cos(t)*x,y:a.y+I*Math.sin(t)*x};if(null!==M&&S(i,a,M,s,e.color),M=s,C===A)break;C=Math.min(C+.5,A)}n=a}return i.push(...k(s[s.length-1],e.color,e.thickness)),{vertices:i}}};class z{constructor(){this.queue=[]}add(e){this.queue.push(e)}remove(e){this.queue.splice(this.queue.findIndex(e),1)}call(...e){for(const t of this.queue)t.apply(void 0,e)}}class U{constructor(e,t=!1){this.panMomentum={x:0,y:0},this.prevPressedPointerMap=new Map,this.pressedPointerMap=new Map,this.onZoom=new z,this.onPan=new z,this.onDown=new z,this.onUp=new z,this.onHover=new z,this.onMove=new z,this.handleOnPointerDown=e=>{const t={x:e.offsetX,y:e.offsetY,type:e.pointerType,pressure:e.pressure,buttons:e.buttons,pagePosition:{x:e.pageX,y:e.pageY},time:performance.now()};this.prevPressedPointerMap.set(e.pointerId,t),this.pressedPointerMap.set(e.pointerId,t),this.onDown.call({position:{x:t.x,y:t.y},pagePosition:t.pagePosition,pointerType:t.type,pressure:t.pressure,buttons:t.buttons}),this.panMomentum.x=0,this.panMomentum.y=0,this.capture&&this.element.setPointerCapture(e.pointerId)},this.handleOnPointerUp=e=>{const t=this.pressedPointerMap.has(e.pointerId);this.prevPressedPointerMap.delete(e.pointerId),this.pressedPointerMap.delete(e.pointerId),t&&this.onUp.call({position:{x:e.offsetX,y:e.offsetY},pagePosition:{x:e.pageX,y:e.pageY},pointerType:e.pointerType,pressure:e.pressure,buttons:e.buttons}),"mouse"===e.pointerType&&this.element.hasPointerCapture(e.pointerId)&&this.element.releasePointerCapture(e.pointerId)},this.handleOnPointerMove=e=>{const t=void 0!==e.getCoalescedEvents?e.getCoalescedEvents():[];if(t.length>0)for(const s of t)this.handleOnPointerMove(s);else{this.pressedPointerMap.has(e.pointerId)&&this.pressedPointerMap.set(e.pointerId,{x:e.offsetX,y:e.offsetY,type:e.pointerType,pressure:e.pressure,buttons:e.buttons,pagePosition:{x:e.pageX,y:e.pageY},time:performance.now()}),this.detectHoverMove(e),this.detectPinchMove(),this.detectPanMove();for(const[e,t]of this.pressedPointerMap)this.prevPressedPointerMap.set(e,t);this.onMove.call({position:{x:e.offsetX,y:e.offsetY},pagePosition:{x:e.pageX,y:e.pageY}})}},this.wheelEventToDeltaPixels=e=>e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?{x:e.deltaX,y:e.deltaY}:e.deltaMode===WheelEvent.DOM_DELTA_LINE?{x:e.deltaX/20,y:e.deltaY/20}:e.deltaMode===WheelEvent.DOM_DELTA_PAGE?{x:e.deltaX/document.body.clientWidth,y:e.deltaY/document.body.clientHeight}:{x:e.deltaX,y:e.deltaY},this.handleOnWheel=e=>{const t=this.wheelEventToDeltaPixels(e);if(e.ctrlKey){let s=1*-t.y;this.onZoom.call({delta:s,around:{x:e.offsetX,y:e.offsetY},method:"scroll"})}else e.shiftKey?this.onPan.call({delta:{x:1*t.y,y:0},position:{x:e.offsetX,y:e.offsetY},pressure:NaN,buttons:e.buttons,pointerType:"scroll",isPinch:!1,pageDelta:{x:1*t.y,y:0},momentum:{x:0,y:0}}):this.onPan.call({delta:{x:1*-t.x,y:1*-t.y},position:{x:e.offsetX,y:e.offsetY},pressure:NaN,buttons:e.buttons,pointerType:"scroll",isPinch:!1,pageDelta:{x:1*-t.x,y:1*-t.y},momentum:{x:0,y:0}});e.preventDefault()},this.element=e,this.capture=t,e.addEventListener("pointermove",this.handleOnPointerMove,{passive:!0}),e.addEventListener("pointerdown",this.handleOnPointerDown,{passive:!0}),e.addEventListener("pointerup",this.handleOnPointerUp,{passive:!0}),e.addEventListener("pointercancel",this.handleOnPointerUp,{passive:!0}),e.addEventListener("pointerout",this.handleOnPointerUp,{passive:!0}),e.addEventListener("pointerleave",this.handleOnPointerUp,{passive:!0}),e.addEventListener("wheel",this.handleOnWheel,{passive:!1})}dispose(){this.element.removeEventListener("pointermove",this.handleOnPointerMove),this.element.removeEventListener("pointerdown",this.handleOnPointerDown),this.element.removeEventListener("pointerup",this.handleOnPointerUp),this.element.removeEventListener("pointercancel",this.handleOnPointerUp),this.element.removeEventListener("pointerout",this.handleOnPointerUp),this.element.removeEventListener("pointerleave",this.handleOnPointerUp),this.element.removeEventListener("wheel",this.handleOnWheel)}isPinch(){if(2===this.pressedPointerMap.size){const e=this.pressedPointerMap.values(),t=e.next().value,s=e.next().value;return"touch"===t.type&&"touch"===s.type}return!1}getMiddle(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}getDistance(e,t){const s=e.x-t.x,n=e.y-t.y;return Math.sqrt(s*s+n*n)}getDifference(e,t){return{x:e.x-t.x,y:e.y-t.y}}detectPinchMove(){if(this.isPinch()){const e=this.prevPressedPointerMap.values(),t=e.next().value,s=e.next().value,n=this.pressedPointerMap.values(),i=n.next().value,o=n.next().value,r=this.getDistance(t,s),a=this.getDistance(i,o)-r,h=this.getMiddle(i,o);this.onZoom.call({delta:a,around:h,method:"pinch"});const l=this.getMiddle(t,s),c=this.getDifference(h,l),u=this.getMiddle(i.pagePosition,o.pagePosition),p=this.getMiddle(t.pagePosition,s.pagePosition),d=this.getDifference(u,p);this.updatePanMomentum(d,i.time-t.time),this.onPan.call({delta:c,position:h,pointerType:i.type,pressure:(i.pressure+o.pressure)/2,buttons:i.buttons|o.buttons,isPinch:!0,pageDelta:d,momentum:this.panMomentum})}}detectHoverMove(e){0===e.buttons&&this.onHover.call({position:{x:e.pageX,y:e.pageY}})}isPan(){return 1===this.pressedPointerMap.size}detectPanMove(){if(this.isPan()){const e=this.prevPressedPointerMap.values().next().value,t=this.pressedPointerMap.values().next().value,s=this.getDifference(t,e),n=this.getDifference(t.pagePosition,e.pagePosition);this.updatePanMomentum(n,t.time-e.time),this.onPan.call({delta:s,position:{x:t.x,y:t.y},pointerType:t.type,pressure:t.pressure,buttons:t.buttons,isPinch:!1,pageDelta:n,momentum:this.panMomentum})}}updatePanMomentum(e,t){this.panMomentum={x:I(this.panMomentum.x,0,t/200),y:I(this.panMomentum.y,0,t/200)},this.panMomentum.x+=e.x,this.panMomentum.y+=e.y}}function F(e,t,s){return t.x<=Math.max(e.x,s.x)&&t.x>=Math.min(e.x,s.x)&&t.y<=Math.max(e.y,s.y)&&t.y>=Math.min(e.y,s.y)}function q(e,t,s){const n=(t.y-e.y)*(s.x-t.x)-(t.x-e.x)*(s.y-t.y);return 0==n?0:n>0?1:2}function G(e,t){const s=q(e[0],e[1],t[0]),n=q(e[0],e[1],t[1]),i=q(t[0],t[1],e[0]),o=q(t[0],t[1],e[1]);return s!=n&&i!=o||(!(0!=s||!F(e[0],t[0],e[1]))||(!(0!=n||!F(e[0],t[1],e[1]))||(!(0!=i||!F(t[0],e[0],t[1]))||!(0!=o||!F(t[0],e[1],t[1])))))}class V{constructor(e){this.isDirty=!1,this.requestedScale="auto",this._actualScale=1,this._dimensions={width:0,height:0},this.onSizeChange=new z,this.programs=[],this.updateSize=()=>{if(null===this._gl.canvas)return;const e=this.actualScale,t=this.dimensions,s=this.targetElement.offsetWidth,n=this.targetElement.offsetHeight;this._actualScale=this.guessScale();const i=this._gl.canvas.width=Math.round(s*this._actualScale),o=this._gl.canvas.height=Math.round(n*this._actualScale);"style"in this._gl.canvas&&(this._gl.canvas.style.width=s+"px",this._gl.canvas.style.height=n+"px"),this._gl.viewport(0,0,i,o),this._dimensions={width:s,height:n},t.width===i&&t.height===o&&e===this.actualScale||this.onSizeChange.call(i,o,this.actualScale),this.requestFrame()},this.onFrame=()=>{this.isDirty=!1,this.clear();for(const e of this.programs)e.draw(this)},this.targetElement=e,this._canvas=document.createElement("canvas"),this.targetElement.appendChild(this._canvas),this._gl=this._canvas.getContext("webgl2"),this.updateSize(),window.addEventListener("resize",this.updateSize)}get gl(){return this._gl}get actualScale(){return this._actualScale}get dimensions(){return this._dimensions}get width(){return this.dimensions.width}get height(){return this.dimensions.height}getContext(){return this._gl}addProgram(e){return this.programs.push(e),e}guessScale(){if("auto"===this.requestedScale){return window.devicePixelRatio}return this.requestedScale}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}requestFrame(){this.isDirty||(this.isDirty=!0,window.requestAnimationFrame(this.onFrame))}dispose(){var e;null==(e=this._gl.getExtension("WEBGL_lose_context"))||e.loseContext(),window.removeEventListener("resize",this.updateSize),this.targetElement.removeChild(this._canvas)}}const H=class{constructor(){this.listeners=new Map}on(e,t){let s=this.listeners.get(e);void 0===s&&(s=[],this.listeners.set(e,s)),s.push(t)}off(e,t){const s=this.listeners.get(e);if(void 0===s)throw"The command have no hooks registred. Perhaps a typo?";{const n=s.filter((e=>e!==t));this.listeners.set(e,n)}}dispatch(e,...t){const s=this.listeners.get(e);if(void 0!==s)for(const n of s)n(...t)}CommandManager(){}static get Instance(){return null===H.instance&&(H.instance=new H),H.instance}};let J=H;J.instance=null;class Y{constructor(e){this._position={x:0,y:0},this._zoom=1,this.setZoom=(e,t)=>{let s=e-this.zoom;const n=this.zoom;n+s<.1&&(s=.1-n);const i=t.x-this.position.x/this.zoom;this.position.x-=i*s;const o=t.y-this.position.y/this.zoom;this.position.y-=o*s,this.zoom+=s},this.glApp=e}get width(){return this.glApp.width}get height(){return this.glApp.height}set position(e){this._position=e,this.glApp.requestFrame()}get position(){return this._position}set zoom(e){this._zoom=e,this.glApp.requestFrame()}get zoom(){return this._zoom}get projection(){return u(p(),this.glApp.width,this.glApp.height)}get view(){const e=d(p(),[this.zoom,this.zoom]),t=g(p(),[this.position.x,this.position.y]);return m(p(),t,e)}get vp_matrix(){return m(p(),this.projection,this.view)}get screen(){return f(this.width,this.height)}}class j extends D{constructor(e,t){super(e),this.vao=null,this.vbo=null,this.data=[],this.isDirty=!1,this.programInfo=null,this.attrbuteLocations={position:0,uv:0,color:0},this.uniformLocations={texture:0},this.cursorImg=new Image,this.width=20,this.initProgram=e=>(this.programInfo=this.createProgramInfo("#version 300 es\nprecision highp float;\n\nin vec4 a_position;\nin vec4 a_color;\nin vec2 a_uv;\n\nout vec4 v_color;\nout vec2 v_uv;\n\nuniform mat3 u_vp;\n\nvoid main() {\n  gl_Position = vec4(u_vp * vec3(a_position.xy, 1), a_position.w);\n  v_color = a_color;\n  v_uv = a_uv;\n}\n  ","#version 300 es\nprecision mediump float;\n\nin vec4 v_color;\nin vec2 v_uv;\n\nout vec4 output_color;\n\nuniform sampler2D u_texture;\n\nvoid main(void) {\n  output_color = texture(u_texture, v_uv);\n}"),this.useProgram(this.programInfo),this.attrbuteLocations.position=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_position"),this.attrbuteLocations.uv=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_uv"),this.attrbuteLocations.color=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_color"),this.uniformLocations.texture=this.glApp.gl.getUniformLocation(this.programInfo.program,"u_texture"),this.setupBuffers(e),this.textures=v(e.gl,{cursor:{src:"assets/cursor@3x.7592a447.png"}}),this.glApp.gl.activeTexture(this.glApp.gl.TEXTURE0),this.glApp.gl.bindTexture(this.glApp.gl.TEXTURE_2D,this.textures.cursor),this.glApp.gl.uniform1i(this.uniformLocations.texture,0),this.glApp.gl.blendFunc(this.glApp.gl.SRC_ALPHA,this.glApp.gl.ONE_MINUS_SRC_ALPHA),this.glApp.gl.enable(this.glApp.gl.BLEND),this.programInfo),this.makeQuad=e=>{const t=this.cursorImg.height/this.cursorImg.width,s=this.width,n=t*s;return[e.x,e.y,0,0,1,0,0,1,e.x+s,e.y,1,0,1,0,0,1,e.x,e.y+n,0,1,1,0,0,1,e.x,e.y+n,0,1,1,0,0,1,e.x+s,e.y,1,0,1,0,0,1,e.x+s,e.y+n,1,1,1,0,0,1]},this.loadData=e=>{this.data=e.map(this.makeQuad).flat(),this.isDirty=!0,this.glApp.requestFrame()},this.draw=e=>{if(null===this.programInfo||null===this.data)return;this.useProgram(this.program),e.gl.bindVertexArray(this.vao),this.isDirty&&(e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.bufferData(this.glApp.gl.ARRAY_BUFFER,new Float32Array(this.data),this.glApp.gl.STREAM_DRAW),this.isDirty=!1);const t=this.data.length/8;c(this.programInfo,{u_vp:this.canvas.vp_matrix}),e.gl.drawArrays(e.gl.TRIANGLES,0,t)},this.canvas=t,this.program=this.initProgram(e),this.cursorImg.src="assets/cursor@3x.7592a447.png"}setupBuffers(e){this.programInfo&&(this.vao=this.glApp.gl.createVertexArray(),e.gl.bindVertexArray(this.vao),this.vbo=this.glApp.gl.createBuffer(),e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.enableVertexAttribArray(this.attrbuteLocations.position),e.gl.enableVertexAttribArray(this.attrbuteLocations.uv),e.gl.enableVertexAttribArray(this.attrbuteLocations.color),e.gl.vertexAttribPointer(this.attrbuteLocations.position,2,this.glApp.gl.FLOAT,!1,32,0),e.gl.vertexAttribPointer(this.attrbuteLocations.uv,2,this.glApp.gl.FLOAT,!1,32,8),e.gl.vertexAttribPointer(this.attrbuteLocations.color,4,this.glApp.gl.FLOAT,!1,32,16))}}class X{constructor(e,t){this.x=e,this.y=t}}class W extends D{constructor(e,t){super(e),this.vao=null,this.vbo=null,this.data=[],this.isDirty=!1,this.programInfo=null,this.attrbuteLocations={position:0,uv:0,color:0},this.uniformLocations={texture:0},this.initProgram=e=>(this.programInfo=this.createProgramInfo("#version 300 es\nprecision highp float;\n\nin vec4 a_position;\nin vec4 a_color;\nin vec2 a_uv;\n\nout vec4 v_color;\nout vec2 v_uv;\nout vec4 v_position;\n\nuniform mat3 u_vp;\n\nvoid main() {\n  gl_Position = a_position;\n  v_color = a_color;\n  v_uv = a_uv;\n  v_position = a_position;\n}\n  ","#version 300 es\nprecision mediump float;\n\nin vec4 v_position;\nin vec4 v_color;\nin vec2 v_uv;\n\nuniform vec2 u_screen;\nuniform vec2 u_position;\nuniform float u_zoom;\n\nout vec4 output_color;\n\nvoid main(void) {\n  float LINE_EVERY_PX = 100.0;\n  float LINE_THICKNESS = 2.0;\n\n  float x = mod(-u_position.x + (v_position.x + 1.0) * 0.5 * u_screen.x, LINE_EVERY_PX * u_zoom);\n  float y = mod(-(u_screen.y - u_position.y) + (v_position.y + 1.0) * 0.5 * u_screen.y, LINE_EVERY_PX * u_zoom);\n\n  float edge = LINE_EVERY_PX * u_zoom - LINE_THICKNESS;\n\n  float alpha = step(0.5, step(edge, x) + step(edge, y));\n  \n  output_color = vec4(v_color.rgb, alpha * v_color.a);\n}"),this.useProgram(this.programInfo),this.attrbuteLocations.position=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_position"),this.attrbuteLocations.uv=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_uv"),this.attrbuteLocations.color=this.glApp.gl.getAttribLocation(this.programInfo.program,"a_color"),this.uniformLocations.texture=this.glApp.gl.getUniformLocation(this.programInfo.program,"u_texture"),this.setupBuffers(e),this.glApp.gl.blendFunc(this.glApp.gl.SRC_ALPHA,this.glApp.gl.ONE_MINUS_SRC_ALPHA),this.glApp.gl.enable(this.glApp.gl.BLEND),this.programInfo),this.makeQuad=()=>{const e=[.7,.7,.7,.8];return[-1,1,0,0,...e,-1,-1,1,0,...e,1,1,0,1,...e,1,1,0,1,...e,-1,-1,1,0,...e,1,-1,1,1,...e]},this.loadData=()=>{this.data=this.makeQuad(),this.isDirty=!0,this.glApp.requestFrame()},this.draw=e=>{if(null===this.programInfo||null===this.data)return;this.useProgram(this.program),e.gl.bindVertexArray(this.vao),this.isDirty&&(e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.bufferData(this.glApp.gl.ARRAY_BUFFER,new Float32Array(this.data),this.glApp.gl.STREAM_DRAW),this.isDirty=!1);const t=this.data.length/8;c(this.programInfo,{u_vp:this.canvas.vp_matrix,u_screen:this.canvas.screen,u_position:f(this.canvas.position.x,this.canvas.position.y),u_zoom:this.canvas.zoom}),e.gl.drawArrays(e.gl.TRIANGLES,0,t)},this.canvas=t,this.program=this.initProgram(e)}setupBuffers(e){this.programInfo&&(this.vao=this.glApp.gl.createVertexArray(),e.gl.bindVertexArray(this.vao),this.vbo=this.glApp.gl.createBuffer(),e.gl.bindBuffer(this.glApp.gl.ARRAY_BUFFER,this.vbo),e.gl.enableVertexAttribArray(this.attrbuteLocations.position),e.gl.enableVertexAttribArray(this.attrbuteLocations.uv),e.gl.enableVertexAttribArray(this.attrbuteLocations.color),e.gl.vertexAttribPointer(this.attrbuteLocations.position,2,this.glApp.gl.FLOAT,!1,32,0),e.gl.vertexAttribPointer(this.attrbuteLocations.uv,2,this.glApp.gl.FLOAT,!1,32,8),e.gl.vertexAttribPointer(this.attrbuteLocations.color,4,this.glApp.gl.FLOAT,!1,32,16))}}class $ extends x.exports.PureComponent{constructor(e){super(e),this.moveStart={x:0,y:0},this.previousErasePoint={x:0,y:0},this.selectStart={x:0,y:0},this.isSelecting=!1,this.drawPointerIsDown=!1,this.erase=!1,this.isDirty=!1,this.hasNew=!1,this.lineGenerator=new L(B,!1,!0),this.pointersRenderer=null,this.lineRenderer=null,this.selectRenderer=null,this.selectedLinesRenderer=null,this.gridRenderer=null,this.canvas=null,this.targetRef=x.exports.createRef(),this.gestureRecognizer=null,this.selectedLines=new Map,this._canDrag=!1,this.setupPointers=e=>{this.props.pointers.onPointerMapUpdated.add((()=>{e.loadData(Array.from(this.props.pointers.pointerMap.values()).map((e=>new X(e.x,e.y))))}))},this.setupGrid=e=>{e.loadData()},this.handleOnMove=e=>{this.props.pointers.updatePoint(this.windowToLocalPoint(e.position))},this.handleOnDelete=()=>{if(this.selectedLines.size>0)for(const e of this.selectedLines.keys())this.props.lines.removeLine(e);this.clearSelectedLines()},this.handleOnPan=e=>{var t;if(this.props.pointers.updatePoint(this.windowToLocalPoint(e.position)),this.canvas)if(this.isSelecting){const s=this.selectStart,n=e.position,i=this.windowToLocalBox({left:Math.min(s.x,n.x),top:Math.min(s.y,n.y),bottom:Math.max(s.y,n.y),right:Math.max(s.x,n.x)}),o=new L(B,!1,!1);this.genBox(o,i),null==(t=this.selectRenderer)||t.loadData(o);const r=this.props.lines.getLinesInside(i);this.selectedLines=r,this.markSelectedLines()}else if(this._canDrag&&"scroll"!==e.pointerType){for(const t of this.selectedLines.keys())this.props.lines.moveLine(t,{x:e.delta.x/this.canvas.zoom,y:e.delta.y/this.canvas.zoom});this.markSelectedLines()}else if(this.props.cursorMode&&"scroll"!==e.pointerType||"pen"===e.pointerType){const t=new C(e.position.x,e.position.y,e.pressure);this.isEraseButtons(e.buttons)||this.props.eraseMode?(this.eraseLine([this.windowToLocalPoint(this.previousErasePoint),this.windowToLocalPoint(t)]),this.previousErasePoint=t):this.addPoint(t)}else"touch"!==e.pointerType&&"scroll"!==e.pointerType||(this.canvas.position={x:this.canvas.position.x+e.delta.x,y:this.canvas.position.y+e.delta.y})},this.handleOnHover=e=>{if(this.selectedLines.size>0){const t=this.detectLineAt(this.windowToLocalPoint(e.position));this.canDrag=void 0!==t}},this.handleOnUp=e=>{var t;this.isSelecting&&(null==(t=this.selectRenderer)||t.loadData(new L(B)),this.isSelecting=!1)},this.handleOnDown=e=>{if(this.lineRenderer&&(this.props.cursorMode||"pen"===e.pointerType)&&!this._canDrag){const t=new C(e.position.x,e.position.y,e.pressure);this.isEraseButtons(e.buttons)||this.props.eraseMode?this.previousErasePoint=t:this.isSelectButtons(e.buttons)?(this.clearSelectedLines(),this.isSelecting=!0,this.selectStart=e.position):(this.props.lines.beginLine(this.props.color,this.props.thickness),this.addPoint(t))}},this.handleOnZoom=e=>{this.canvas&&(this.props.cursorMode&&"pinch"===e.method||this.canvas.setZoom(this.canvas.zoom+.008*e.delta*this.canvas.zoom,{x:e.around.x/this.canvas.zoom,y:e.around.y/this.canvas.zoom}))},this.handleOnContextMenu=e=>{e.preventDefault()},this.isEraseButtons=e=>32===e,this.isSelectButtons=e=>2===e,this.eraseLine=e=>{const t=this.detectLineBetween(e);t&&this.props.lines.removeLine(t)},this.detectLineAt=(e,t=5)=>{var s;const n={x:e.x,y:e.y+t},i={x:e.x,y:e.y-t},o={x:e.x-t,y:e.y},r={x:e.x+t,y:e.y};return null!=(s=this.detectLineBetween([n,i]))?s:this.detectLineBetween([o,r])},this.detectLineBetween=e=>{if(null===this.lineRenderer)throw"LineRenderer is null. Perhaps something isn't initialised yet?";const t=this.props.lines.getLines();for(const[s,n]of t)if(1===n.points.length)for(const t of e){const e=n.points[0].x-t.x,i=n.points[0].y-t.y;if(e*e+i*i<36)return s}else for(let t=1;t<n.points.length;t++){if(G(e,[n.points[t-1],n.points[t-0]]))return s}},e.lines.onChange.add((t=>{var s;if("add"===t.name||"upd"===t.name||"mv"===t.name){const s=e.lines.getLines().get(t.id);s&&this.lineGenerator.addLine(t.id,s)}else"rmv"===t.name&&this.lineGenerator.removeLine(t.id);this.hasNew=!0,null==(s=this.lineRenderer)||s.loadData(this.lineGenerator)}))}componentDidMount(){if(null===this.targetRef.current)throw new Error("Could not find target element");const e=new V(this.targetRef.current);this.canvas=new Y(e),this.gridRenderer=e.addProgram(new W(e,this.canvas)),this.selectedLinesRenderer=e.addProgram(new O(e,this.canvas)),this.lineRenderer=e.addProgram(new O(e,this.canvas)),this.selectRenderer=e.addProgram(new O(e,this.canvas)),this.pointersRenderer=e.addProgram(new j(e,this.canvas)),this.setupPointers(this.pointersRenderer),this.setupGrid(this.gridRenderer),this.gestureRecognizer=new U(this.targetRef.current),this.gestureRecognizer.onZoom.add(this.handleOnZoom),this.gestureRecognizer.onDown.add(this.handleOnDown),this.gestureRecognizer.onUp.add(this.handleOnUp),this.gestureRecognizer.onHover.add(this.handleOnHover),this.gestureRecognizer.onMove.add(this.handleOnMove),this.gestureRecognizer.onPan.add(this.handleOnPan),this.targetRef.current.addEventListener("contextmenu",this.handleOnContextMenu),J.Instance.on("delete",this.handleOnDelete)}componentDidUpdate(){for(const[e,t]of this.selectedLines)this.props.lines.updateLine(e,this.props.color,this.props.thickness);this.selectedLines.size>0&&this.markSelectedLines(),J.Instance.off("delete",this.handleOnDelete)}clearSelectedLines(){this.selectedLines.clear(),this.markSelectedLines()}genBox(e,t,s=[.7,.7,.7,1]){e.addLine(Math.round(Math.random()*Number.MAX_SAFE_INTEGER),{color:s,points:[new C(t.left,t.top),new C(t.right,t.top),new C(t.right,t.bottom),new C(t.left,t.bottom),new C(t.left,t.top)],thickness:.5})}markSelectedLines(){var e;const t=new L(B,!1,!0);for(const[s,n]of this.selectedLines){const e={points:n.points,color:[.8,.8,.8,1],thickness:n.thickness+2};t.addLine(s,e)}null==(e=this.selectedLinesRenderer)||e.loadData(t)}windowToLocalPoint(e){return null===this.canvas?e:h(a({},e),{x:(e.x-this.canvas.position.x)/this.canvas.zoom,y:(e.y-this.canvas.position.y)/this.canvas.zoom})}windowToLocalBox(e){return null===this.canvas?e:h(a({},e),{left:(e.left-this.canvas.position.x)/this.canvas.zoom,right:(e.right-this.canvas.position.x)/this.canvas.zoom,top:(e.top-this.canvas.position.y)/this.canvas.zoom,bottom:(e.bottom-this.canvas.position.y)/this.canvas.zoom})}componentWillUnmount(){var e;null==(e=this.gestureRecognizer)||e.dispose(),null!==this.targetRef.current&&this.targetRef.current.removeEventListener("contextmenu",this.handleOnContextMenu)}addPoint(e){var t,s;if(this.canvas&&(e.x-=this.canvas.position.x,e.y-=this.canvas.position.y,e.x/=this.canvas.zoom,e.y/=this.canvas.zoom),this.previousPoint){const n=this.previousPoint.x-e.x,i=this.previousPoint.y-e.y,o=2/(null!=(s=null==(t=this.canvas)?void 0:t.zoom)?s:1);if(n*n+i*i<o*o)return}this.props.lines.addPoint(e),this.previousPoint=e}set canDrag(e){e!==this._canDrag&&null!==this.targetRef.current&&(this.targetRef.current.style.cursor=e?"move":"auto"),this._canDrag=e}render(){return x.exports.createElement("div",{style:{position:"relative",height:"100%"}},x.exports.createElement("div",{ref:this.targetRef,style:{touchAction:"none",overflow:"hidden",height:"100%"}}))}}var K="_container_12ykj_1",Z="_colorButton_12ykj_11",Q="_colorWheel_12ykj_22";function ee(e){return`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${e[3]})`}const te=({color:e,onPick:t})=>{const s=x.exports.useRef(null);if("custom"===e){const e=e=>{const s=function(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255,1]}(e.currentTarget.value);null==t||t(s)};return x.exports.createElement(x.exports.Fragment,null,x.exports.createElement("input",{style:{display:"none"},type:"color",ref:s,onChange:e}),x.exports.createElement("button",{className:`${Z} ${Q}`,onClick:()=>{var e;return null==(e=s.current)?void 0:e.click()}}))}return x.exports.createElement("button",{className:Z,style:{background:ee(e)},onClick:()=>null==t?void 0:t(e)})},se=({onPick:e,className:t})=>x.exports.createElement("div",{className:y(K,t)},x.exports.createElement(te,{color:[0,0,0,1],onPick:e}),x.exports.createElement(te,{color:[1,1,1,1],onPick:e}),x.exports.createElement(te,{color:[217/255,227/255,36/255,1],onPick:e}),x.exports.createElement(te,{color:[217/255,227/255,36/255,1],onPick:e}),x.exports.createElement(te,{color:[237/255,148/255,69/255,1],onPick:e}),x.exports.createElement(te,{color:[214/255,73/255,199/255,1],onPick:e}),x.exports.createElement(te,{color:[69/255,121/255,237/255,1],onPick:e}),x.exports.createElement(te,{color:[66/255,227/255,117/255,1],onPick:e}),x.exports.createElement(te,{color:"custom",onPick:e}));var ne="_content_9j2lt_1",ie="_cursorCheckbox_9j2lt_11",oe="_canvasPreview_9j2lt_15",re="_colorPicker_9j2lt_20";var ae="_container_2uybv_1";const he=e=>{const t=x.exports.useCallback((t=>{var s;null==(s=e.onChange)||s.call(e,t.currentTarget.checked)}),[e.onChange]);return x.exports.createElement("label",{htmlFor:e.id,className:y(ae,e.className)},x.exports.createElement("input",{id:e.id,type:"checkbox",checked:e.checked,onChange:t}),x.exports.createElement("img",{src:e.src,width:e.width,height:e.height}))};function le(e){return e.substr(1)}function ce(){const[e,t]=x.exports.useState(le(location.hash));x.exports.useEffect((()=>{function e(){t(le(location.hash))}return window.addEventListener("hashchange",e),()=>{window.removeEventListener("hashchange",e)}}),[t]);return{hash:e,setHash:x.exports.useCallback((e=>{location.hash=`#${e}`}),[])}}var ue="_userListItem_1kbc6_2",pe="_userListItemLoading_1kbc6_17";const de=e=>{return x.exports.createElement("div",{className:y({[ue]:!0,[pe]:(t=e.user.state,"connected"!==t)}),title:`${e.user.name} - ${e.user.state}`},e.user.name.substr(0,1).toUpperCase());var t},ge=e=>x.exports.createElement(x.exports.Fragment,null,x.exports.createElement(de,{user:{id:"",name:e.localName,state:"connected"}}),e.users.map((e=>x.exports.createElement(de,{key:e.id,user:e}))));class me{constructor(){this.queue=[],this.lastCall=Number.MIN_SAFE_INTEGER,this.throttleTimer=null}add(e){this.queue.push(e)}remove(e){this.queue.splice(this.queue.findIndex(e),1)}call(...e){for(const t of this.queue)t(...e);this.lastCall=performance.now()}callThrottled(e,...t){const s=performance.now()-this.lastCall;null!==this.throttleTimer&&clearTimeout(this.throttleTimer),s>e?this.call(...t):this.throttleTimer=setTimeout((()=>{this.call(...t),this.throttleTimer=null}),s)}}class fe{constructor(e,t){this.onMessage=new me,this.connection=e,this.connection.onMessage.add(this.handleOnMessage.bind(this)),this.channel=t}handleOnMessage(e,t){const s=JSON.parse(e);if(Array.isArray(s)&&s[0]===this.channel){const e=s[1];if(void 0===t.remoteId)throw new Error("Sender doesn t have a remote id!");this.onMessage.call(e,this)}}send(e){const t=[this.channel,e],s=JSON.stringify(t);this.connection.send(s)}}class ve{constructor(e,t="BB"){this.bDeliver=new me,this.channels=[],this.handleOnConnection=e=>{const t=new fe(e,this.header);this.channels.push(t),t.onMessage.add(this.receive)},this.receive=(e,t)=>{this.bDeliver.call(e,t.connection)},this.network=e,this.header=t;for(const s of this.network.connections)this.handleOnConnection(s);this.network.onConnection.add(this.handleOnConnection)}bBroadcast(e){this.bDeliver.call(e,this.network.loopback),this.broadcast(e)}broadcast(e){const t=[this.header,e],s=JSON.stringify(t);for(const n of this.network.connections)n.send(s)}toJSON(){return{}}}class xe{constructor(e,t=!1){if(t)this.counters=null;else if(Array.isArray(e)){this.counters=new Map;for(let t=0;t<e.length;t++)this.counters.set(t,e[t])}else if(e instanceof Map)this.counters=e;else{this.counters=new Map;for(let t=0;t<e;t++)this.counters.set(t,0)}}get size(){return null!==this.counters?this.counters.size:0}get(e){if(null===this.counters)return 0;{const t=this.counters.get(e);return void 0!==t?t:0}}set(e,t){null!==this.counters&&this.counters.set(e,t)}keys(){return null!==this.counters?this.counters.keys():[]}compareTo(e){let t=!1,s=!1,n=!1;if(null===this.counters&&null===e.counters)return{hasGreater:!1,hasLesser:!1,hasEqual:!0};if(null===this.counters)return{hasLesser:!0,hasGreater:!1,hasEqual:!1};if(null===e.counters)return{hasLesser:!1,hasGreater:!0,hasEqual:!1};if(this.size!==e.size)throw new Error(`Both vector clocks must be of same length. The first was of length ${this.size} while the other was of length ${e.size}`);for(const i of this.counters.keys())this.get(i)>e.get(i)?t=!0:this.get(i)<e.get(i)?s=!0:this.get(i)===e.get(i)&&(n=!0);return{hasGreater:t,hasLesser:s,hasEqual:n}}bottomClock(){this.counters=null}isEqual(e){const t=this.compareTo(e);return t.hasEqual&&!t.hasLesser&&!t.hasGreater}isLessOrEqual(e){const t=this.compareTo(e);return(t.hasLesser||t.hasEqual)&&!t.hasGreater}isStrictlyLess(e){return this.isLessOrEqual(e)&&!this.isEqual(e)}isConcurrent(e){const t=this.compareTo(e);return t.hasGreater&&t.hasLesser}toJson(){return JSON.stringify(this)}toJSON(){return null===this.counters?null:Array.from(this.counters.entries())}static fromJson(e){const t=JSON.parse(e);if(null===t)return new xe(0,!0);return new xe(new Map(t))}clone(){return null!==this.counters?new xe(new Map(this.counters)):xe.BottomedClock}toArray(){return this.counters?Array.from(this.counters.entries()):[]}}xe.BottomedClock=new xe(0,!0);const ye={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class we{constructor(e,t=ye){this.onLocalIceCandidate=new me,this.onConnectionStateChange=new me,this.onChannelOpen=new me,this.onMessage=new me,this.handleOnConnectionStateChange=()=>{void 0!==this.pc&&(this.pc.iceConnectionState,this.onConnectionStateChange.call(this.pc.iceConnectionState,this))},this.handleOnIceCandidate=e=>{null!==e.candidate&&this.onLocalIceCandidate.call(e.candidate)},this.handleOnDataChannel=e=>{this.channel=e.channel,this.setupChannel()},this.handleOnChannelOpen=()=>{this.onChannelOpen.call()},this.handleOnChannelMessage=e=>{this.onMessage.call(e.data,this)},this.setRemoteDescription=async e=>{if(void 0===this.pc)throw new Error("Peer connection is uninitialised");await this.pc.setRemoteDescription(new RTCSessionDescription(e))},this.createAnswer=async e=>{if(this.initialise(),this.setRemoteDescription(e),void 0!==this.pc){const e=await this.pc.createAnswer();if(await this.pc.setLocalDescription(e),null!==this.pc.localDescription)return this.pc.localDescription;throw new Error("Could not generate answer from offer")}throw new Error("Peer Connection in uninitialised")},this.createOffer=async()=>{if(this.initialise(),void 0!==this.pc){this.channel=this.pc.createDataChannel("channel"),this.setupChannel();const e=await this.pc.createOffer();if(await this.pc.setLocalDescription(e),null!==this.pc.localDescription)return this.pc.localDescription;throw new Error("Could  not create offer")}throw new Error("Peer Connection in uninitialised")},this.addRemoteIceCandidate=async e=>{if(void 0===this.pc)throw new Error("Peer Connection in uninitialised");e instanceof RTCIceCandidate?await this.pc.addIceCandidate(e):await this.pc.addIceCandidate(new RTCIceCandidate(e))},this.remoteId=e,this.config=t}get connectionState(){return this.pc?this.pc.iceConnectionState:"new"}initialise(){this.pc=new RTCPeerConnection(this.config),this.pc.onicecandidate=this.handleOnIceCandidate,this.pc.ondatachannel=this.handleOnDataChannel,this.pc.oniceconnectionstatechange=this.handleOnConnectionStateChange}setupChannel(){this.channel&&(this.channel.onmessage=this.handleOnChannelMessage,this.channel.onopen=this.handleOnChannelOpen)}send(e){if(!this.channel)throw new Error("Channel hasn't been opened");"string"==typeof e||e instanceof Blob||ArrayBuffer,this.channel.send(e)}close(){this.pc&&this.pc.close()}}var Pe,_e;(_e=Pe||(Pe={}))[_e.PING=0]="PING",_e[_e.PONG=1]="PONG",_e[_e.NEW_PEER=2]="NEW_PEER",_e[_e.DESCRIPTION=3]="DESCRIPTION",_e[_e.ICE_CANDIDATE=4]="ICE_CANDIDATE",_e[_e.ASSIGNED_PEER_ID=5]="ASSIGNED_PEER_ID",_e[_e.JOIN_ROOM=6]="JOIN_ROOM";class Ee{constructor(e,t){this.event=e,this.args=t}toJson(){return JSON.stringify([this.event,this.args])}isPing(){return this.event===Pe.PING}isPong(){return this.event===Pe.PONG}isJoinRoom(){return this.event===Pe.JOIN_ROOM}isNewPeer(){return this.event===Pe.NEW_PEER}isDescription(){return this.event===Pe.DESCRIPTION}isIceCandidate(){return this.event===Pe.ICE_CANDIDATE}isAssignedPeerId(){return this.event===Pe.ASSIGNED_PEER_ID}static fromJson(e){const t=JSON.parse(e),s=t[0],n=t[1];switch(s){case Pe.PING:return new be;case Pe.PONG:return new Ae;case Pe.NEW_PEER:return new Ie(n[0]);case Pe.DESCRIPTION:return new Me(n[0],n[1]);case Pe.ICE_CANDIDATE:return new Ce(n[0],n[1]);case Pe.ASSIGNED_PEER_ID:return new Le(n[0]);case Pe.JOIN_ROOM:return new De(n[0]);default:throw new Error("Unknown SignallingEvent")}}}class be extends Ee{constructor(){super(Pe.PING)}}class Ae extends Ee{constructor(){super(Pe.PONG)}}class Ie extends Ee{constructor(e){super(Pe.NEW_PEER,[e]),this.peerId=e}}class Me extends Ee{constructor(e,t){super(Pe.DESCRIPTION,[e,t]),this.remoteDescription=e,this.peerId=t}}class Ce extends Ee{constructor(e,t){super(Pe.ICE_CANDIDATE,[e,t]),this.iceCandidate=e,this.peerId=t}}class Le extends Ee{constructor(e){super(Pe.ASSIGNED_PEER_ID,[e]),this.peerId=e}}class De extends Ee{constructor(e){super(Pe.JOIN_ROOM,[e]),this.roomId=e}}class Oe{constructor(e,t,s,n){this.handleOnOpen=()=>{var e;null==(e=this.onOpen)||e.call(this)},this.handleOnClose=e=>{var t;null==(t=this.onClose)||t.call(this)},this.handleOnMessage=e=>{var t,s,n,i;if("string"==typeof e.data){const o=Ee.fromJson(e.data);o.isNewPeer()&&(null==(t=this.onNewPeer)||t.call(this,o)),o.isDescription()&&(null==(s=this.onDescription)||s.call(this,o)),o.isIceCandidate()&&(null==(n=this.onIceCandidate)||n.call(this,o)),o.isAssignedPeerId()&&(null==(i=this.onAssignedPeerId)||i.call(this,o))}},this.send=e=>{var t;null==(t=this.ws)||t.send(e.toJson())},this.onAssignedPeerId=e,this.onNewPeer=t,this.onDescription=s,this.onIceCandidate=n}get readyState(){var e;return null==(e=this.ws)?void 0:e.readyState}async connect(e){return new Promise((t=>{this.ws=new w(e),this.ws.onopen=()=>{this.handleOnOpen(),t()},this.ws.onclose=this.handleOnClose,this.ws.onmessage=this.handleOnMessage}))}joinRoom(e){this.ws&&this.ws.send(new De(e).toJson())}close(){var e;null==(e=this.ws)||e.close()}}class Re{constructor(e){this.onChannelOpen=new me,this.onMessage=new me,this.onConnectionStateChange=new me,this.connectionState="connected",this.remoteId=e,setTimeout((()=>{this.onChannelOpen.call()}),0)}send(e){this.onMessage.call(e,this)}close(){this.connectionState="closed"}}class Se{constructor(e,t){this.allPeers=new Map,this.pendingPeers=new Map,this.connectedPeers=new Map,this.onConnection=new me,this.onDisconnect=new me,this.onPendingConnection=new me,this.onJoinedRoom=new me,this.handleOnAssignedPeerId=e=>{this.localId=e.peerId,this.loopback=new Re(e.peerId),this.onJoinedRoom.call(e.peerId)},this.handleOnNewPeer=async e=>{const t=this.createNewConnection(e.peerId),s=await t.createOffer();this.signalling.send(new Me(s,e.peerId))},this.handleOnDescription=async e=>{if("offer"===e.remoteDescription.type){const t=this.createNewConnection(e.peerId),s=await t.createAnswer(e.remoteDescription);this.signalling.send(new Me(s,e.peerId))}else{const t=this.allPeers.get(e.peerId);if(!t)throw new Error(`Couldn't find connection with peer id ${e.peerId}`);t.setRemoteDescription(e.remoteDescription)}},this.handleOnIceCandidate=e=>{const t=this.allPeers.get(e.peerId);if(!t)throw new Error(`Couldn't find connection with peer id ${e.peerId}`);t.addRemoteIceCandidate(e.iceCandidate)},this.handleOnConnectionStateChange=(e,t)=>{"closed"===e&&(this.onDisconnect.call(t),this.allPeers.delete(t.remoteId),this.connectedPeers.delete(t.remoteId))},this.rtcConfiguration=t,this.signallingUrl=e,this.signalling=new Oe(this.handleOnAssignedPeerId,this.handleOnNewPeer,this.handleOnDescription,this.handleOnIceCandidate)}get connections(){return Array.from(this.connectedPeers.values())}get pendingConnections(){return Array.from(this.pendingPeers.values())}async joinRoom(e){await this.signalling.connect(this.signallingUrl),this.signalling.joinRoom(e),this.currentRoomId=e}createNewConnection(e){const t=new we(e,this.rtcConfiguration);return this.allPeers.set(e,t),this.pendingPeers.set(e,t),this.onPendingConnection.call(t),t.onConnectionStateChange.add(this.handleOnConnectionStateChange),t.onLocalIceCandidate.add((t=>{this.signalling.send(new Ce(t,e))})),t.onChannelOpen.add((()=>{this.connectedPeers.has(e)||(this.connectedPeers.set(e,t),this.pendingPeers.delete(e)),this.onConnection.call(t)})),t}close(){this.signalling.close();for(const e of this.allPeers.values())e.close();this.allPeers.clear(),this.connectedPeers.clear()}toJSON(){return{signalling:this.signalling,allPeers:Array.from(this.allPeers.entries()),connectedPeers:Array.from(this.connectedPeers.entries()),localId:this.localId}}}class Ne{constructor(){this.connections=[],this.pendingConnections=[],this.onConnection=new me,this.onPendingConnection=new me}}class ke{constructor(e){this.onChange=new me,this.currentId=0,this.lines=new Map,this.boundingBoxes=new Map,this.handleOnDeliver=e=>{if("begin"===e.name)this.lines.set(e.id,{points:[],color:e.color,thickness:e.thickness});else if("add"===e.name){const t=this.lines.get(e.id);null==t||t.points.push(e.point),this.updateBoundingBox(e.id,[e.point]),this.onChange.call(e)}else if("rmv"===e.name)this.lines.delete(e.id),this.boundingBoxes.delete(e.id),this.onChange.call(e);else if("upd"===e.name){const t=this.lines.get(e.id);t&&(t.color=e.color,t.thickness=e.thickness,this.onChange.call(e))}else if("mv"===e.name){const t=this.lines.get(e.id);t&&(t.points.forEach((t=>{t.x+=e.delta.x,t.y+=e.delta.y})),this.onChange.call(e),this.boundingBoxes.delete(e.id),this.updateBoundingBox(e.id,t.points))}},this.beginLine=(e=[0,0,0,1],t=1)=>(this.currentId=Math.round(Math.random()*Number.MAX_SAFE_INTEGER),this.bb.bBroadcast({name:"begin",id:this.currentId,color:e,thickness:t}),this.currentId),this.addPoint=e=>{this.bb.bBroadcast({name:"add",id:this.currentId,point:e})},this.removeLine=e=>{this.bb.bBroadcast({name:"rmv",id:e})},this.updateLine=(e,t=[0,0,0,1],s=1)=>{this.bb.bBroadcast({name:"upd",id:e,color:t,thickness:s})},this.getLines=()=>this.lines,this.moveLine=(e,t)=>{this.bb.bBroadcast({name:"mv",id:e,delta:t})},this.fmn=e,this.bb=new ve(e,"Lines"),this.bb.bDeliver.add(this.handleOnDeliver);for(const t of this.fmn.connections)t.send(JSON.stringify(["sync_request"]));this.fmn.onConnection.add((e=>{e.send(JSON.stringify(["sync_request"]));e.onMessage.add((t=>{const s=JSON.parse(t);if(Array.isArray(s))if("sync_request"===s[0])e.send(JSON.stringify(["sync_response",Array.from(this.lines.entries())]));else if("sync_response"===s[0])for(const[e,n]of s[1])this.lines.set(e,n),this.updateBoundingBox(e,n.points),this.onChange.call({name:"add",id:e})}))}))}updateBoundingBox(e,t){var s;const n=null!=(s=this.boundingBoxes.get(e))?s:{left:1/0,right:-1/0,top:1/0,bottom:-1/0};for(const i of t)n.left=Math.min(n.left,i.x),n.right=Math.max(n.right,i.x),n.top=Math.min(n.top,i.y),n.bottom=Math.max(n.bottom,i.y);this.boundingBoxes.set(e,n)}getIntersection(e,t){const s=Math.max(e.top,t.top),n=Math.min(e.bottom,t.bottom),i=Math.max(e.left,t.left),o=Math.min(e.right,t.right);return i<o&&s<n?{top:s,bottom:n,left:i,right:o}:null}getArea(e){return(e.right-e.left)*(e.bottom-e.top)}getLinesInside(e){const t=new Map;for(const[s,n]of this.boundingBoxes){const i=this.getIntersection(e,n);i&&this.getArea(i)>this.getArea(n)/2&&t.set(s,this.lines.get(s))}return t}}const Te=["red","blue","green"],Be=["panda","llama","koala"];function ze(e){return e[Math.floor(Math.random()*e.length)]}class Ue{constructor(e){this.channels=new Map,this.localName=`${ze(Te)} ${ze(Be)}`,this.userMap=new Map,this.onUsersUpdated=new me,this.onPendingConnection=e=>{var t;const s=null==(t=e.remoteId)?void 0:t.toString();void 0!==s&&(this.userMap.set(s,{id:s,name:"New user",state:e.connectionState}),this.onUsersUpdated.call())},this.onConnection=e=>{const t=new fe(e,"user_list");this.channels.set(e.remoteId,t),t.onMessage.add(this.onMessage),this.sendNameTo(t),t.connection.onConnectionStateChange.add(((e,t)=>{var s;const n=null==(s=t.remoteId)?void 0:s.toString();if(void 0!==n){const t=this.userMap.get(n);t&&(t.state=e,this.onUsersUpdated.call())}}))},this.onMessage=(e,t)=>{switch(e.type){case"join":this.userMap.set(e.user.id,h(a({},e.user),{state:t.connection.connectionState})),this.onUsersUpdated.call();break;case"leave":this.userMap.delete(e.userId),this.onUsersUpdated.call();break;default:throw new Error("Unknown message type")}},this.fmn=e,this.init()}get users(){return Array.from(this.userMap.values())}init(){for(const e of this.fmn.pendingConnections)this.onConnection(e);this.fmn.onPendingConnection.add(this.onPendingConnection);for(const e of this.fmn.connections)this.onConnection(e);this.fmn.onConnection.add(this.onConnection)}dispose(){for(const e of this.channels.values())e.onMessage.remove(this.onMessage)}sendNameTo(e){var t;if(!this.fmn.localId)return;const s={user:{id:null==(t=this.fmn.localId)?void 0:t.toString(),name:this.localName},type:"join"};e.send(s)}join(e){if(this.localName=e,this.fmn.localId)for(const t of this.channels.values())this.sendNameTo(t)}leave(){if(!this.fmn.localId)return;const e={userId:this.fmn.localId.toString(),type:"leave"};for(const t of this.channels.values())t.send(e)}}class Fe{constructor(e){this.pointerMap=new Map,this.onPointerMapUpdated=new me,this.onMessage=(e,t)=>{"update"===e.type&&t.remoteId!==this.fmn.localId&&(this.pointerMap.set(e.id,e.point),this.onPointerMapUpdated.call())},this.updatePoint=e=>{if(void 0===this.fmn.localId)return;const t={type:"update",id:this.fmn.localId.toString(),point:e};this.bb.bBroadcast(t)},this.fmn=e,this.bb=new ve(this.fmn,"pointers"),this.init()}init(){this.bb.bDeliver.add(this.onMessage)}}const qe={lines:new ke(new Ne),userList:new Ue(new Ne),pointers:new Fe(new Ne)},Ge=P.createContext(qe),{Consumer:Ve,Provider:He}=Ge,Je=()=>{const{userList:e}=x.exports.useContext(Ge),[t,s]=x.exports.useState([]);return x.exports.useEffect((()=>{function t(){s(e.users)}return e.onUsersUpdated.add(t),()=>{e.onUsersUpdated.remove(t)}}),[e]),x.exports.createElement(ge,{users:t,localName:e.localName})},Ye="abcdefghijklmnopqrstuvwxyz1234567890";const je=e=>{const{hash:t,setHash:s}=ce();let n=x.exports.useRef(null);const i=x.exports.useCallback((e=>{const t=new V(e);n.current=t.addProgram(new O(t,new Y(t)))}),[]);x.exports.useEffect((()=>{var t;function s(){if(n.current){const t=new L(B,!0),s=n.current.glApp.width,i=n.current.glApp.height;t.addLine(0,{points:[{pressure:.8,x:5*e.thickness,y:5*e.thickness},{pressure:.6,x:.4*s,y:.9*i},{pressure:.5,x:.6*s,y:.2*i},{pressure:.2,x:s-5*e.thickness,y:i-5*e.thickness}],color:e.color,thickness:e.thickness}),n.current.loadData(t)}}return s(),null==(t=n.current)||t.glApp.onSizeChange.add(s),()=>{var e;null==(e=n.current)||e.glApp.onSizeChange.remove(s)}}),[e.color,e.thickness,n.current]);return x.exports.createElement("div",{className:ne},x.exports.createElement("div",{className:oe,ref:i}),x.exports.createElement(se,{onPick:e.onColorChange,className:re}),x.exports.createElement("input",{type:"range",min:"0.1",max:"3",step:"0.2",value:e.thickness,onChange:t=>{var s;null==(s=e.onThicknessChange)||s.call(e,t.currentTarget.valueAsNumber)}}),x.exports.createElement("div",null,x.exports.createElement(he,{src:"assets/cursormode.f054aa65.svg",id:"mode-cursor-mobile",width:32,height:32,checked:e.cursorMode,onChange:t=>{var s;null==(s=e.onCursorModeChange)||s.call(e,t)},className:ie}),x.exports.createElement(he,{src:"assets/eraser.a53e9dc1.svg",id:"mode-eraser-mobile",width:32,height:32,checked:e.eraseMode,onChange:t=>{var s;null==(s=e.onEraseModeChange)||s.call(e,t)}})),t.length>0?x.exports.createElement(x.exports.Fragment,null,x.exports.createElement("label",null,"Invite URL:"),x.exports.createElement("input",{type:"text",value:location.href,readOnly:!0,style:{width:`${location.href.length}ch`}})):x.exports.createElement("button",{onClick:()=>{0===t.length&&s(function(e){const t=new Array(e);for(let s=0;s<e;s++)t[s]=Ye[Math.floor(Math.random()*Ye.length)];return t.join("")}(10))}},"Invite Collaborator"),x.exports.createElement(Je,null))};var Xe,We,$e="_main_1kiwy_1";(We=Xe||(Xe={}))[We.Alt=0]="Alt",We[We.Ctrl=1]="Ctrl",We[We.Shift=2]="Shift";class Ke{constructor(e=window.document.body){this.shortcuts=new Map,this.handleOnKeyDown=e=>{for(const[t,s]of this.shortcuts){const n=this.parseKeyCombination(t);let i=e.key.toLowerCase()===n.key.toLowerCase();for(const t of n.modifiers)1===t?i=i&&e.ctrlKey:2===t?i=i&&e.shiftKey:0===t&&(i=i&&e.altKey);if(i){s.call(),e.preventDefault();break}}},this.element=e,this.element.addEventListener("keydown",this.handleOnKeyDown)}dispose(){this.element.removeEventListener("keydown",this.handleOnKeyDown)}create(e){if(this.shortcuts.has(e))return this.shortcuts.get(e);{const t=new z;return this.shortcuts.set(e,t),t}}parseModifier(e){switch(e.toLowerCase()){case"ctrl":return 1;case"shift":return 2;case"alt":return 0;default:throw`${e} is not a valid modifier`}}parseKeyCombination(e){const t=e.split("+"),s=[];if(0===t.length)throw"Empty combination is not allowed as a shortcut";for(;t.length>1;)s.push(this.parseModifier(t.shift()));return{modifiers:s,key:t.shift()}}}const Ze=e=>{const t=x.exports.useRef(null);return null===t.current&&(t.current=e()),t.current};var Qe="_container_1d7xw_1",et="_handle_1d7xw_11",tt="_handleDot_1d7xw_19";class st{constructor(e=0){this.duration=200,this.startTime=0,this.frameRequested=!1,this.onAnimate=new z,this.onDone=new z,this.animationLoop=()=>{this.frameRequested=!1;const e=(performance.now()-this.startTime)/this.duration;this.value=M(this.fromValue,this.targetValue,e),this.onAnimate.call(this.value),this.value!==this.targetValue?this.requestFrame():this.onDone.call()},this.value=e,this.fromValue=e,this.targetValue=e}animateTo(e,t=200,s=null){this.duration=t,this.fromValue=null!==s?s:this.value,this.targetValue=e,this.startTime=performance.now(),this.requestFrame()}requestFrame(){this.frameRequested||(window.requestAnimationFrame(this.animationLoop),this.frameRequested=!0)}}const nt=e=>{const t=x.exports.useRef(null),s=x.exports.useRef(null),n=x.exports.useRef(null),i=x.exports.useRef(new st),o=x.exports.useRef(!0),r=x.exports.useRef(0),a=x.exports.useRef({x:0,y:0});return x.exports.useEffect((()=>{let e=t.current,h=s.current;function l(){if(e&&h){const t=e.scrollHeight-r.current-h.scrollHeight;e.style.transform=`translate3d(0, ${t}px, 0)`}}return o.current&&e&&h&&(r.current=e.scrollHeight-h.scrollHeight),h&&(n.current=new U(h,!0),n.current.onPan.add((t=>{if("scroll"===t.pointerType){let s;t.delta.y<0&&e&&h?(s=e.scrollHeight-h.scrollHeight,o.current=!0):(s=0,o.current=!1),i.current.animateTo(s,200,r.current)}else r.current-=t.pageDelta.y,e&&h&&(r.current=Math.min(r.current,e.scrollHeight-h.scrollHeight)),r.current=Math.max(r.current,0),l(),a.current=t.momentum})),n.current.onDown.add((t=>{o.current&&e&&h&&(r.current=e.scrollHeight-h.scrollHeight)})),n.current.onUp.add((t=>{let s;a.current.y<0&&e&&h?(s=e.scrollHeight-h.scrollHeight,o.current=!0):(s=0,o.current=!1),i.current.animateTo(s,200,r.current)}))),i.current.onAnimate.add((e=>{r.current=e,l()})),()=>{n.current&&n.current.dispose()}}),[s.current,t.current]),x.exports.createElement("div",{ref:t,className:Qe},x.exports.createElement("div",{ref:s,className:et},x.exports.createElement("div",{className:tt})),e.children)},it=()=>{const{hash:e,setHash:t}=ce(),[s,n]=x.exports.useState(),i=Ze((()=>new Se("wss://notes-signalling.herokuapp.com"))),o=Ze((()=>new ke(i))),r=Ze((()=>new Ue(i))),a=Ze((()=>new Fe(i))),h=Ze((()=>new Ke));x.exports.useEffect((()=>{!async function(){const e=await fetch("https://q4q0hqrcx3.execute-api.eu-north-1.amazonaws.com/twilio-turn-get-token",{mode:"cors"}),t=await e.json();n(t)}()}),[]),x.exports.useEffect((()=>{void 0!==s&&(i.rtcConfiguration={iceServers:s.ice_servers})}),[s]),x.exports.useEffect((()=>{h.create("Delete").add((()=>{J.Instance.dispatch("delete")}))}),[h]),x.exports.useEffect((()=>{if(void 0!==s&&e.length>0&&null!==o&&null!==i&&e!==i.currentRoomId){if(void 0!==i.currentRoomId&&o.getLines().size>0){if(!window.confirm("All changes will be deleted if you change room. Do you want to continue?"))return void t(i.currentRoomId)}if(void 0!==i.currentRoomId){i.close();for(const[e]of o.getLines())o.removeLine(e)}i.joinRoom(e)}}),[e,o,i,r,s]);const[l,c]=x.exports.useState(!0),[u,p]=x.exports.useState(!1),[d,g]=x.exports.useState([0,0,0,1]),[m,f]=x.exports.useState(1);return x.exports.createElement(He,{value:{userList:r,lines:o,pointers:a}},x.exports.createElement("main",{className:$e},x.exports.createElement($,{color:d,thickness:m,lines:o,eraseMode:u,cursorMode:l,pointers:a}),x.exports.createElement("header",null,x.exports.createElement(nt,null,x.exports.createElement(je,{onColorChange:g,onThicknessChange:f,onCursorModeChange:c,onEraseModeChange:p,thickness:m,color:d,eraseMode:u,cursorMode:l})))))};function ot(){const e=document.getElementById("app");_.exports.render(x.exports.createElement(it,null),e)}"complete"===document.readyState?ot():window.addEventListener("load",ot);
